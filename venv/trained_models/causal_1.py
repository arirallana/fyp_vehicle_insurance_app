import dowhy
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import econml


dataset = pd.read_csv('Car_Insurance_Claim.csv')

# Replacing missing values with column average
dataset.isnull().sum()
dataset['CREDIT_SCORE'].fillna((dataset['CREDIT_SCORE'].mean()), inplace=True)
dataset['ANNUAL_MILEAGE'].fillna((dataset['ANNUAL_MILEAGE'].mean()), inplace=True)
dataset = dataset.drop(['ID', 'RACE','MARRIED','CHILDREN','POSTAL_CODE','VEHICLE_YEAR'], axis=1)

#state causal relations
rel_str= """VEHICLE_OWNERSHIP->DRIVING_EXPERIENCE; DRIVING_EXPERIENCE->SPEEDING_VIOLATIONS; 
DRIVING_EXPERIENCE->DUIS; DRIVING_EXPERIENCE->PAST_ACCIDENTS; VEHICLE_OWNERSHIP->CREDIT_SCORE; 
SPEEDING_VIOLATIONS->CREDIT_SCORE; SPEEDING_VIOLATIONS->PAST_ACCIDENTS; DUIS->CREDIT_SCORE; 
DUIS->SPEEDING_VIOLATIONS; DUIS->PAST_ACCIDENTS;PAST_ACCIDENTS->CREDIT_SCORE; VEHICLE_OWNERSHIP->OUTCOME; 
DRIVING_EXPERIENCE->OUTCOME; SPEEDING_VIOLATIONS->OUTCOME; DUIS->OUTCOME; PAST_ACCIDENTS->OUTCOME; 
VEHICLE_OWNERSHIP->OUTCOME; CREDIT_SCORE->OUTCOME; VEHICLE_TYPE->ANNUAL_MILEAGE; ANNUAL_MILEAGE->CREDIT_SCORE; 
VEHICLE_TYPE->CREDIT_SCORE; AGE->DRIVING_EXPERIENCE; AGE->EDUCATION; AGE->INCOME; AGE->VEHICLE_OWNERSHIP; 
GENDER->EDUCATION; GENDER->INCOME; GENDER->VEHICLE_TYPE; EDUCATION->INCOME; INCOME->VEHICLE_OWNERSHIP; 
INCOME->VEHICLE_TYPE; AGE->SPEEDING_VIOLATIONS; AGE->DUIS; AGE->PAST_ACCIDENTS; AGE->CREDIT_SCORE;
EDUCATION->CREDIT_SCORE; INCOME->CREDIT_SCORE;"""


#create causal graph
import pygraphviz
causal_graph = """digraph {
VEHICLE_OWNERSHIP[label="VEHICLE_OWNED"];
OUTCOME[label="CLAIM FILED"];
AGE;
GENDER;
DRIVING_EXPERIENCE;
EDUCATION;
INCOME;
CREDIT_SCORE;
ANNUAL_MILEAGE;
VEHICLE_TYPE;
SPEEDING_VIOLATIONS;
DUIS;
PAST_ACCIDENTS;
"""+rel_str+"""
}"""

from IPython.display import Image, display
display(Image(filename="causal_model.png"))

print(dataset.head())

#rewrite causal graph using encoded categorical variables
rel_str_expanded = """DRIVING_EXPERIENCE_0_9y->SPEEDING_VIOLATIONS;DRIVING_EXPERIENCE_10_19y->SPEEDING_VIOLATIONS;DRIVING_EXPERIENCE_20_29y->SPEEDING_VIOLATIONS;DRIVING_EXPERIENCE_30y->SPEEDING_VIOLATIONS;DRIVING_EXPERIENCE_0_9y->DUIS;DRIVING_EXPERIENCE_10_19y->DUIS;DRIVING_EXPERIENCE_20_29y->DUIS;DRIVING_EXPERIENCE_30y->DUIS;DRIVING_EXPERIENCE_0_9y->PAST_ACCIDENTS;DRIVING_EXPERIENCE_10_19y->PAST_ACCIDENTS;DRIVING_EXPERIENCE_20_29y->PAST_ACCIDENTS;DRIVING_EXPERIENCE_30y->PAST_ACCIDENTS;VEHICLE_OWNERSHIP_0->CREDIT_SCORE;VEHICLE_OWNERSHIP_1->CREDIT_SCORE;SPEEDING_VIOLATIONS->CREDIT_SCORE;SPEEDING_VIOLATIONS->PAST_ACCIDENTS;DUIS->CREDIT_SCORE;DUIS->SPEEDING_VIOLATIONS;DUIS->PAST_ACCIDENTS;PAST_ACCIDENTS->CREDIT_SCORE;VEHICLE_OWNERSHIP_0->OUTCOME;VEHICLE_OWNERSHIP_1->OUTCOME;DRIVING_EXPERIENCE_0_9y->OUTCOME;DRIVING_EXPERIENCE_10_19y->OUTCOME;DRIVING_EXPERIENCE_20_29y->OUTCOME;DRIVING_EXPERIENCE_30y->OUTCOME;SPEEDING_VIOLATIONS->OUTCOME;DUIS->OUTCOME;PAST_ACCIDENTS->OUTCOME;VEHICLE_OWNERSHIP_0->OUTCOME;VEHICLE_OWNERSHIP_1->OUTCOME;CREDIT_SCORE->OUTCOME;VEHICLE_TYPE_sedan->ANNUAL_MILEAGE;VEHICLE_TYPE_sports_car->ANNUAL_MILEAGE;ANNUAL_MILEAGE->CREDIT_SCORE;VEHICLE_TYPE_sedan->CREDIT_SCORE;VEHICLE_TYPE_sports_car->CREDIT_SCORE;AGE_16_25->DRIVING_EXPERIENCE_0_9y;AGE_26_39->DRIVING_EXPERIENCE_10_19y;AGE_40_64->DRIVING_EXPERIENCE_20_29y;AGE_65->DRIVING_EXPERIENCE_30y;AGE_16_25->DRIVING_EXPERIENCE_0_9y;AGE_26_39->DRIVING_EXPERIENCE_10_19y;AGE_65->DRIVING_EXPERIENCE_20_29y;AGE_40_64->DRIVING_EXPERIENCE_30y;AGE_16_25->DRIVING_EXPERIENCE_0_9y;AGE_40_64->DRIVING_EXPERIENCE_10_19y;AGE_26_39->DRIVING_EXPERIENCE_20_29y;AGE_65->DRIVING_EXPERIENCE_30y;AGE_16_25->DRIVING_EXPERIENCE_0_9y;AGE_40_64->DRIVING_EXPERIENCE_10_19y;AGE_65->DRIVING_EXPERIENCE_20_29y;AGE_26_39->DRIVING_EXPERIENCE_30y;AGE_16_25->DRIVING_EXPERIENCE_0_9y;AGE_65->DRIVING_EXPERIENCE_10_19y;AGE_26_39->DRIVING_EXPERIENCE_20_29y;AGE_40_64->DRIVING_EXPERIENCE_30y;AGE_16_25->DRIVING_EXPERIENCE_0_9y;AGE_65->DRIVING_EXPERIENCE_10_19y;AGE_40_64->DRIVING_EXPERIENCE_20_29y;AGE_26_39->DRIVING_EXPERIENCE_30y;AGE_26_39->DRIVING_EXPERIENCE_0_9y;AGE_16_25->DRIVING_EXPERIENCE_10_19y;AGE_40_64->DRIVING_EXPERIENCE_20_29y;AGE_65->DRIVING_EXPERIENCE_30y;AGE_26_39->DRIVING_EXPERIENCE_0_9y;AGE_16_25->DRIVING_EXPERIENCE_10_19y;AGE_65->DRIVING_EXPERIENCE_20_29y;AGE_40_64->DRIVING_EXPERIENCE_30y;AGE_26_39->DRIVING_EXPERIENCE_0_9y;AGE_40_64->DRIVING_EXPERIENCE_10_19y;AGE_16_25->DRIVING_EXPERIENCE_20_29y;AGE_65->DRIVING_EXPERIENCE_30y;AGE_26_39->DRIVING_EXPERIENCE_0_9y;AGE_40_64->DRIVING_EXPERIENCE_10_19y;AGE_65->DRIVING_EXPERIENCE_20_29y;AGE_16_25->DRIVING_EXPERIENCE_30y;AGE_26_39->DRIVING_EXPERIENCE_0_9y;AGE_65->DRIVING_EXPERIENCE_10_19y;AGE_16_25->DRIVING_EXPERIENCE_20_29y;AGE_40_64->DRIVING_EXPERIENCE_30y;AGE_26_39->DRIVING_EXPERIENCE_0_9y;AGE_65->DRIVING_EXPERIENCE_10_19y;AGE_40_64->DRIVING_EXPERIENCE_20_29y;AGE_16_25->DRIVING_EXPERIENCE_30y;AGE_40_64->DRIVING_EXPERIENCE_0_9y;AGE_16_25->DRIVING_EXPERIENCE_10_19y;AGE_26_39->DRIVING_EXPERIENCE_20_29y;AGE_65->DRIVING_EXPERIENCE_30y;AGE_40_64->DRIVING_EXPERIENCE_0_9y;AGE_16_25->DRIVING_EXPERIENCE_10_19y;AGE_65->DRIVING_EXPERIENCE_20_29y;AGE_26_39->DRIVING_EXPERIENCE_30y;AGE_40_64->DRIVING_EXPERIENCE_0_9y;AGE_26_39->DRIVING_EXPERIENCE_10_19y;AGE_16_25->DRIVING_EXPERIENCE_20_29y;AGE_65->DRIVING_EXPERIENCE_30y;AGE_40_64->DRIVING_EXPERIENCE_0_9y;AGE_26_39->DRIVING_EXPERIENCE_10_19y;AGE_65->DRIVING_EXPERIENCE_20_29y;AGE_16_25->DRIVING_EXPERIENCE_30y;AGE_40_64->DRIVING_EXPERIENCE_0_9y;AGE_65->DRIVING_EXPERIENCE_10_19y;AGE_16_25->DRIVING_EXPERIENCE_20_29y;AGE_26_39->DRIVING_EXPERIENCE_30y;AGE_40_64->DRIVING_EXPERIENCE_0_9y;AGE_65->DRIVING_EXPERIENCE_10_19y;AGE_26_39->DRIVING_EXPERIENCE_20_29y;AGE_16_25->DRIVING_EXPERIENCE_30y;AGE_65->DRIVING_EXPERIENCE_0_9y;AGE_16_25->DRIVING_EXPERIENCE_10_19y;AGE_26_39->DRIVING_EXPERIENCE_20_29y;AGE_40_64->DRIVING_EXPERIENCE_30y;AGE_65->DRIVING_EXPERIENCE_0_9y;AGE_16_25->DRIVING_EXPERIENCE_10_19y;AGE_40_64->DRIVING_EXPERIENCE_20_29y;AGE_26_39->DRIVING_EXPERIENCE_30y;AGE_65->DRIVING_EXPERIENCE_0_9y;AGE_26_39->DRIVING_EXPERIENCE_10_19y;AGE_16_25->DRIVING_EXPERIENCE_20_29y;AGE_40_64->DRIVING_EXPERIENCE_30y;AGE_65->DRIVING_EXPERIENCE_0_9y;AGE_26_39->DRIVING_EXPERIENCE_10_19y;AGE_40_64->DRIVING_EXPERIENCE_20_29y;AGE_16_25->DRIVING_EXPERIENCE_30y;AGE_65->DRIVING_EXPERIENCE_0_9y;AGE_40_64->DRIVING_EXPERIENCE_10_19y;AGE_16_25->DRIVING_EXPERIENCE_20_29y;AGE_26_39->DRIVING_EXPERIENCE_30y;AGE_65->DRIVING_EXPERIENCE_0_9y;AGE_40_64->DRIVING_EXPERIENCE_10_19y;AGE_26_39->DRIVING_EXPERIENCE_20_29y;AGE_16_25->DRIVING_EXPERIENCE_30y;AGE_16_25->EDUCATION_high_school;AGE_26_39->EDUCATION_none;AGE_40_64->EDUCATION_university;AGE_16_25->EDUCATION_high_school;AGE_26_39->EDUCATION_none;AGE_65->EDUCATION_university;AGE_16_25->EDUCATION_high_school;AGE_40_64->EDUCATION_none;AGE_26_39->EDUCATION_university;AGE_16_25->EDUCATION_high_school;AGE_40_64->EDUCATION_none;AGE_65->EDUCATION_university;AGE_16_25->EDUCATION_high_school;AGE_65->EDUCATION_none;AGE_26_39->EDUCATION_university;AGE_16_25->EDUCATION_high_school;AGE_65->EDUCATION_none;AGE_40_64->EDUCATION_university;AGE_26_39->EDUCATION_high_school;AGE_16_25->EDUCATION_none;AGE_40_64->EDUCATION_university;AGE_26_39->EDUCATION_high_school;AGE_16_25->EDUCATION_none;AGE_65->EDUCATION_university;AGE_26_39->EDUCATION_high_school;AGE_40_64->EDUCATION_none;AGE_16_25->EDUCATION_university;AGE_26_39->EDUCATION_high_school;AGE_40_64->EDUCATION_none;AGE_65->EDUCATION_university;AGE_26_39->EDUCATION_high_school;AGE_65->EDUCATION_none;AGE_16_25->EDUCATION_university;AGE_26_39->EDUCATION_high_school;AGE_65->EDUCATION_none;AGE_40_64->EDUCATION_university;AGE_40_64->EDUCATION_high_school;AGE_16_25->EDUCATION_none;AGE_26_39->EDUCATION_university;AGE_40_64->EDUCATION_high_school;AGE_16_25->EDUCATION_none;AGE_65->EDUCATION_university;AGE_40_64->EDUCATION_high_school;AGE_26_39->EDUCATION_none;AGE_16_25->EDUCATION_university;AGE_40_64->EDUCATION_high_school;AGE_26_39->EDUCATION_none;AGE_65->EDUCATION_university;AGE_40_64->EDUCATION_high_school;AGE_65->EDUCATION_none;AGE_16_25->EDUCATION_university;AGE_40_64->EDUCATION_high_school;AGE_65->EDUCATION_none;AGE_26_39->EDUCATION_university;AGE_65->EDUCATION_high_school;AGE_16_25->EDUCATION_none;AGE_26_39->EDUCATION_university;AGE_65->EDUCATION_high_school;AGE_16_25->EDUCATION_none;AGE_40_64->EDUCATION_university;AGE_65->EDUCATION_high_school;AGE_26_39->EDUCATION_none;AGE_16_25->EDUCATION_university;AGE_65->EDUCATION_high_school;AGE_26_39->EDUCATION_none;AGE_40_64->EDUCATION_university;AGE_65->EDUCATION_high_school;AGE_40_64->EDUCATION_none;AGE_16_25->EDUCATION_university;AGE_65->EDUCATION_high_school;AGE_40_64->EDUCATION_none;AGE_26_39->EDUCATION_university;AGE_16_25->INCOME_middle_class;AGE_26_39->INCOME_poverty;AGE_40_64->INCOME_upper_class;AGE_65->INCOME_working_class;AGE_16_25->INCOME_middle_class;AGE_26_39->INCOME_poverty;AGE_65->INCOME_upper_class;AGE_40_64->INCOME_working_class;AGE_16_25->INCOME_middle_class;AGE_40_64->INCOME_poverty;AGE_26_39->INCOME_upper_class;AGE_65->INCOME_working_class;AGE_16_25->INCOME_middle_class;AGE_40_64->INCOME_poverty;AGE_65->INCOME_upper_class;AGE_26_39->INCOME_working_class;AGE_16_25->INCOME_middle_class;AGE_65->INCOME_poverty;AGE_26_39->INCOME_upper_class;AGE_40_64->INCOME_working_class;AGE_16_25->INCOME_middle_class;AGE_65->INCOME_poverty;AGE_40_64->INCOME_upper_class;AGE_26_39->INCOME_working_class;AGE_26_39->INCOME_middle_class;AGE_16_25->INCOME_poverty;AGE_40_64->INCOME_upper_class;AGE_65->INCOME_working_class;AGE_26_39->INCOME_middle_class;AGE_16_25->INCOME_poverty;AGE_65->INCOME_upper_class;AGE_40_64->INCOME_working_class;AGE_26_39->INCOME_middle_class;AGE_40_64->INCOME_poverty;AGE_16_25->INCOME_upper_class;AGE_65->INCOME_working_class;AGE_26_39->INCOME_middle_class;AGE_40_64->INCOME_poverty;AGE_65->INCOME_upper_class;AGE_16_25->INCOME_working_class;AGE_26_39->INCOME_middle_class;AGE_65->INCOME_poverty;AGE_16_25->INCOME_upper_class;AGE_40_64->INCOME_working_class;AGE_26_39->INCOME_middle_class;AGE_65->INCOME_poverty;AGE_40_64->INCOME_upper_class;AGE_16_25->INCOME_working_class;AGE_40_64->INCOME_middle_class;AGE_16_25->INCOME_poverty;AGE_26_39->INCOME_upper_class;AGE_65->INCOME_working_class;AGE_40_64->INCOME_middle_class;AGE_16_25->INCOME_poverty;AGE_65->INCOME_upper_class;AGE_26_39->INCOME_working_class;AGE_40_64->INCOME_middle_class;AGE_26_39->INCOME_poverty;AGE_16_25->INCOME_upper_class;AGE_65->INCOME_working_class;AGE_40_64->INCOME_middle_class;AGE_26_39->INCOME_poverty;AGE_65->INCOME_upper_class;AGE_16_25->INCOME_working_class;AGE_40_64->INCOME_middle_class;AGE_65->INCOME_poverty;AGE_16_25->INCOME_upper_class;AGE_26_39->INCOME_working_class;AGE_40_64->INCOME_middle_class;AGE_65->INCOME_poverty;AGE_26_39->INCOME_upper_class;AGE_16_25->INCOME_working_class;AGE_65->INCOME_middle_class;AGE_16_25->INCOME_poverty;AGE_26_39->INCOME_upper_class;AGE_40_64->INCOME_working_class;AGE_65->INCOME_middle_class;AGE_16_25->INCOME_poverty;AGE_40_64->INCOME_upper_class;AGE_26_39->INCOME_working_class;AGE_65->INCOME_middle_class;AGE_26_39->INCOME_poverty;AGE_16_25->INCOME_upper_class;AGE_40_64->INCOME_working_class;AGE_65->INCOME_middle_class;AGE_26_39->INCOME_poverty;AGE_40_64->INCOME_upper_class;AGE_16_25->INCOME_working_class;AGE_65->INCOME_middle_class;AGE_40_64->INCOME_poverty;AGE_16_25->INCOME_upper_class;AGE_26_39->INCOME_working_class;AGE_65->INCOME_middle_class;AGE_40_64->INCOME_poverty;AGE_26_39->INCOME_upper_class;AGE_16_25->INCOME_working_class;AGE_16_25->VEHICLE_OWNERSHIP_0;AGE_26_39->VEHICLE_OWNERSHIP_1;AGE_16_25->VEHICLE_OWNERSHIP_0;AGE_40_64->VEHICLE_OWNERSHIP_1;AGE_16_25->VEHICLE_OWNERSHIP_0;AGE_65->VEHICLE_OWNERSHIP_1;AGE_26_39->VEHICLE_OWNERSHIP_0;AGE_16_25->VEHICLE_OWNERSHIP_1;AGE_26_39->VEHICLE_OWNERSHIP_0;AGE_40_64->VEHICLE_OWNERSHIP_1;AGE_26_39->VEHICLE_OWNERSHIP_0;AGE_65->VEHICLE_OWNERSHIP_1;AGE_40_64->VEHICLE_OWNERSHIP_0;AGE_16_25->VEHICLE_OWNERSHIP_1;AGE_40_64->VEHICLE_OWNERSHIP_0;AGE_26_39->VEHICLE_OWNERSHIP_1;AGE_40_64->VEHICLE_OWNERSHIP_0;AGE_65->VEHICLE_OWNERSHIP_1;AGE_65->VEHICLE_OWNERSHIP_0;AGE_16_25->VEHICLE_OWNERSHIP_1;AGE_65->VEHICLE_OWNERSHIP_0;AGE_26_39->VEHICLE_OWNERSHIP_1;AGE_65->VEHICLE_OWNERSHIP_0;AGE_40_64->VEHICLE_OWNERSHIP_1;GENDER_female->VEHICLE_TYPE_sedan;GENDER_male->VEHICLE_TYPE_sports_car;GENDER_male->VEHICLE_TYPE_sedan;GENDER_female->VEHICLE_TYPE_sports_car;INCOME_middle_class->VEHICLE_OWNERSHIP_0;INCOME_poverty->VEHICLE_OWNERSHIP_1;INCOME_middle_class->VEHICLE_OWNERSHIP_0;INCOME_upper_class->VEHICLE_OWNERSHIP_1;INCOME_middle_class->VEHICLE_OWNERSHIP_0;INCOME_working_class->VEHICLE_OWNERSHIP_1;INCOME_poverty->VEHICLE_OWNERSHIP_0;INCOME_middle_class->VEHICLE_OWNERSHIP_1;INCOME_poverty->VEHICLE_OWNERSHIP_0;INCOME_upper_class->VEHICLE_OWNERSHIP_1;INCOME_poverty->VEHICLE_OWNERSHIP_0;INCOME_working_class->VEHICLE_OWNERSHIP_1;INCOME_upper_class->VEHICLE_OWNERSHIP_0;INCOME_middle_class->VEHICLE_OWNERSHIP_1;INCOME_upper_class->VEHICLE_OWNERSHIP_0;INCOME_poverty->VEHICLE_OWNERSHIP_1;INCOME_upper_class->VEHICLE_OWNERSHIP_0;INCOME_working_class->VEHICLE_OWNERSHIP_1;INCOME_working_class->VEHICLE_OWNERSHIP_0;INCOME_middle_class->VEHICLE_OWNERSHIP_1;INCOME_working_class->VEHICLE_OWNERSHIP_0;INCOME_poverty->VEHICLE_OWNERSHIP_1;INCOME_working_class->VEHICLE_OWNERSHIP_0;INCOME_upper_class->VEHICLE_OWNERSHIP_1;INCOME_middle_class->VEHICLE_TYPE_sedan;INCOME_poverty->VEHICLE_TYPE_sports_car;INCOME_middle_class->VEHICLE_TYPE_sedan;INCOME_upper_class->VEHICLE_TYPE_sports_car;INCOME_middle_class->VEHICLE_TYPE_sedan;INCOME_working_class->VEHICLE_TYPE_sports_car;INCOME_poverty->VEHICLE_TYPE_sedan;INCOME_middle_class->VEHICLE_TYPE_sports_car;INCOME_poverty->VEHICLE_TYPE_sedan;INCOME_upper_class->VEHICLE_TYPE_sports_car;INCOME_poverty->VEHICLE_TYPE_sedan;INCOME_working_class->VEHICLE_TYPE_sports_car;INCOME_upper_class->VEHICLE_TYPE_sedan;INCOME_middle_class->VEHICLE_TYPE_sports_car;INCOME_upper_class->VEHICLE_TYPE_sedan;INCOME_poverty->VEHICLE_TYPE_sports_car;INCOME_upper_class->VEHICLE_TYPE_sedan;INCOME_working_class->VEHICLE_TYPE_sports_car;INCOME_working_class->VEHICLE_TYPE_sedan;INCOME_middle_class->VEHICLE_TYPE_sports_car;INCOME_working_class->VEHICLE_TYPE_sedan;INCOME_poverty->VEHICLE_TYPE_sports_car;INCOME_working_class->VEHICLE_TYPE_sedan;INCOME_upper_class->VEHICLE_TYPE_sports_car;AGE_16_25->SPEEDING_VIOLATIONS;AGE_26_39->SPEEDING_VIOLATIONS;AGE_40_64->SPEEDING_VIOLATIONS;AGE_65->SPEEDING_VIOLATIONS;AGE_16_25->DUIS;AGE_26_39->DUIS;AGE_40_64->DUIS;AGE_65->DUIS;AGE_16_25->PAST_ACCIDENTS;AGE_26_39->PAST_ACCIDENTS;AGE_40_64->PAST_ACCIDENTS;AGE_65->PAST_ACCIDENTS;AGE_16_25->CREDIT_SCORE;AGE_26_39->CREDIT_SCORE;AGE_40_64->CREDIT_SCORE;AGE_65->CREDIT_SCORE;EDUCATION_high_school->CREDIT_SCORE;EDUCATION_none->CREDIT_SCORE;EDUCATION_university->CREDIT_SCORE;INCOME_middle_class->CREDIT_SCORE;INCOME_poverty->CREDIT_SCORE;INCOME_upper_class->CREDIT_SCORE;INCOME_working_class->CREDIT_SCORE;"""

causal_graph_expanded = """digraph {
VEHICLE_TYPE_sedan;
VEHICLE_TYPE_sports_car;
VEHICLE_OWNERSHIP_0;
VEHICLE_OWNERSHIP_1;
GENDER_female;
GENDER_male;
EDUCATION_high_school; 
EDUCATION_none;
EDUCATION_university;
INCOME_middle_class;
INCOME_poverty;
INCOME_upper_class;
INCOME_working_class;
DRIVING_EXPERIENCE_0_9y;
DRIVING_EXPERIENCE_10_19y;
DRIVING_EXPERIENCE_20_29y;
DRIVING_EXPERIENCE_30y;
AGE_16_25; 
AGE_26_39; 
AGE_40_64;
AGE_65;
CREDIT_SCORE;
ANNUAL_MILEAGE;
SPEEDING_VIOLATIONS;
DUIS;
PAST_ACCIDENTS;
OUTCOME;
"""+rel_str_expanded+"""
}"""


confounders_continuous = [
'CREDIT_SCORE',
'SPEEDING_VIOLATIONS',
'ANNUAL_MILEAGE',
'DUIS',
'PAST_ACCIDENTS',
]

confounders_categorical = [
'VEHICLE_TYPE',
'GENDER',
'VEHICLE_OWNERSHIP',
'EDUCATION',
'INCOME',
'DRIVING_EXPERIENCE',
'AGE']


one_hot_encoded_data = pd.get_dummies(dataset, columns = confounders_categorical)
one_hot_encoded_data = one_hot_encoded_data.sample(n=10)

one_hot_encoded_data = one_hot_encoded_data.rename(columns={'VEHICLE_TYPE_sports car': 'VEHICLE_TYPE_sports_car',
                                                            'EDUCATION_high school': 'EDUCATION_high_school',
                                                           'INCOME_middle class':'INCOME_middle_class',
                                                           'INCOME_upper class':'INCOME_upper_class',
                                                           'INCOME_working class':'INCOME_working_class',
                                                           'DRIVING_EXPERIENCE_0-9y':'DRIVING_EXPERIENCE_0_9y',
                                                           'DRIVING_EXPERIENCE_10-19y':'DRIVING_EXPERIENCE_10_19y',
                                                           'DRIVING_EXPERIENCE_20-29y':'DRIVING_EXPERIENCE_20_29y',
                                                           'DRIVING_EXPERIENCE_30y+':'DRIVING_EXPERIENCE_30y',
                                                           'AGE_16-25':'AGE_16_25',
                                                           'AGE_26-39':'AGE_26_39',
                                                           'AGE_40-64':'AGE_40_64',
                                                           'AGE_65+':'AGE_65'})
print(one_hot_encoded_data)


print(one_hot_encoded_data.columns)


from IPython.display import Image, display
display(Image(filename="causal_model_exapnded.png"))

effects = {}
for i in one_hot_encoded_data.columns:
    model = dowhy.CausalModel(data=one_hot_encoded_data, graph=causal_graph_expanded.replace("\n", " "), treatment=i,
                              outcome='OUTCOME')

    # from IPython.display import Image, display
    # display(Image(filename="causal_model.png"))

    print(i)
    identified_estimand_experiment = model.identify_effect(proceed_when_unidentifiable=True)
    causal_estimate_reg = model.estimate_effect(identified_estimand_experiment,
                                                method_name="backdoor.linear_regression",
                                                test_significance=True)
    print(causal_estimate_reg)
    effects[i] = causal_estimate_reg
print(effects)
